<div class="c-edit">
  <div class="c-edit__toolbar">
    <Toolbar onModeChange="{setMode}"></Toolbar>
  </div>

  <div class="c-edit__main">
    <GraphNetwork
      mode="{mode}"
      bind:this="{graphViewer}"
    ></GraphNetwork>
    <div class="c-edit__menu">
      <Menu onBack="{onBack}" onSave="{onSave}"></Menu>
    </div>
  </div>

  <div class="c-edit__sidebar">
    <Sidebar bind:this="{sidebar}"></Sidebar>
  </div>
</div>

<style>
  .c-edit {
    display: flex;
    flex-flow: row nowrap;
    width: 100%;
    height: 100%;
  }

  .c-edit__toolbar {
    flex: 0 0 auto;
  }

  .c-edit__main {
    flex: auto;
    overflow: hidden;
    position: relative;
    background: hsl(0, 0%, 90%);
  }

  .c-edit__menu {
    position: absolute;
    right: 0;
    top: 0;
  }

  .c-edit__sidebar {
    flex: 0 auto;
    width: 300px;
  }
</style>

<script>
  import { onMount } from 'svelte'

  import Toolbar from './toolbar.html'
  import Sidebar from './sidebar.html'
  import Menu from './menu.html'
  import GraphNetwork from './graph-network/graph-network.html'

  import { loadSvgImage } from '../../ajax/image'
  import {
    createGraph,
    removeGraph,
    loadGraph,
    updateGraph,
    graphAdded,
    graphRemoved,
    graphUpdated
  } from '../../graphql/graph'
  import {
    updateSearchParams,
    getSearchParams
  } from '../../utils/location'
  import { requireAuth, usePage } from '../../utils/page'
  import { Mode } from './graph-network/graph-network.html'
  import {
    UndirectedGraph,
    DirectedGraph,
    GraphType
  } from '../../data/graph'

  let graphViewer
  let sidebar
  let mode = Mode.SELECT

  const page = usePage()

  onMount(async () => {
    const params = getSearchParams()

    if (params.id) {
      const graph = await loadGraph(params.id)

      if (graph.type === GraphType.UNDIRECTED_GRAPH) {
        graphViewer.setGraph(UndirectedGraph.fromJSON(graph))
      } else {
        graphViewer.setGraph(DirectedGraph.fromJSON(graph))
      }
    } else if (params.type === 'undirected-graph') {
      graphViewer.setGraph(new UndirectedGraph())
    } else {
      graphViewer.setGraph(new DirectedGraph())
    }
  })

  function setMode(newMode) {
    mode = newMode
  }

  function onBack() {
    page('/dashboard')
  }

  async function onSave() {
    const title = sidebar.getTitle()
    const graph = graphViewer.getGraph().toJSON()

    try {
      await createGraph({
        title,
        ...graph
      })
    } catch (error) {
      throw error
    }
  }
</script>
