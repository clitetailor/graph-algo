<div class="c-editor__layout">
  <GraphNetwork
    bind:this="{gn}"
    bind:graph="{graph}"
    bind:offsetX="{offsetX}"
    bind:offsetY="{offsetY}"
    bind:scale="{scale}"
    onSvgMount="{onSvgMount}"
    onSvgMouseDown="{onSvgMouseDown}"
    onSvgMouseWheel="{onSvgMouseWheel}"
    onSvgClick="{onSvgClick}"
    onNodeClick="{onNodeClick}"
    onNodeMouseDown="{onNodeMouseDown}"
    onEdgeClick="{onEdgeClick}"
  ></GraphNetwork>
</div>

<svelte:window
  on:keydown="{onWindowKeyDown}"
  on:mouseup="{onWindowMouseUp}"
  on:mousemove="{onWindowMouseMove}"
></svelte:window>

<style>
  .c-editor__layout {
    width: 100%;
    height: 100%;
    padding: 20px;
  }
</style>

<script>
  import { onMount } from 'svelte'

  import GraphNetwork from './graph-network/graph-network.html'

  let gn
  let graph = {
    nodes: [],
    edges: []
  }

  const ModeType = {
    SELECT_MODE: 'SELECT_MODE',
    MOVE_MODE: 'MOVE_MODE',
    NODE_MODE: 'NODE_MODE',
    LINE_MODE: 'LINE_MODE'
  }

  export let mode = ModeType.NODE_MODE
  let currentMode = mode
  let isModeLocked = false

  let offsetX = 0
  let offsetY = 0
  let scale = 1

  let isSvgDragging = false
  let isNodeDragging = false
  let draggingNode

  function getMouseCoordinates(event) {
    const rect = gn.getBoundingClientRect()

    let x = (event.clientX - rect.left - offsetX) / scale
    let y = (event.clientY - rect.top - offsetY) / scale

    return {
      x,
      y
    }
  }

  function onSvgMount() {
    offsetX = gn.getWidth() / 2
    offsetY = gn.getHeight() / 2
  }

  function setMode(event) {
    if (isModeLocked) {
      return
    }

    if (isSelectMode(event)) {
      mode = ModeType.SELECT_MODE
    }

    if (isMoveMode(event)) {
      mode = ModeType.MOVE_MODE
    }

    if (isNodeMode(event)) {
      mode = ModeType.NODE_MODE
    }

    if (isLineMode(event)) {
      mode = ModeType.LINE_MODE
    }

    gn.clearSelections()

    currentMode = mode
  }

  function isSelectMode(event) {
    return event.key === 's' && !event.altKey && !event.ctrlKey
  }

  function isMoveMode(event) {
    return event.key === 'm' && !event.altKey && !event.ctrlKey
  }

  function isNodeMode(event) {
    return event.key === 'n' && !event.altKey && !event.ctrlKey
  }

  function isLineMode(event) {
    return event.key === 'l' && !event.altKey && !event.ctrlKey
  }

  function onSvgMouseDown(event) {
    if (mode === ModeType.MOVE_MODE) {
      onSvgDragStart(event)
    }
  }

  function onWindowMouseMove(event) {
    if (mode === ModeType.MOVE_MODE && isSvgDragging) {
      onSvgDrag(event)
    }

    if (mode === ModeType.MOVE_MODE && isNodeDragging) {
      onNodeDrag(event)
    }
  }

  function onSvgMouseWheel(event) {
    const wheelDelta = -event.wheelDelta

    let newScale = scale - wheelDelta / 5000
    if (newScale > 0 && newScale < 2) {
      scale = newScale
    }
  }

  function onSvgClick(event) {
    switch (mode) {
      case ModeType.NODE_MODE:
        if (!event.altKey) {
          const mouseCoordinates = getMouseCoordinates(event)

          gn.createNodeAt(
            mouseCoordinates.x,
            mouseCoordinates.y
          )
        }
        break
    }
  }

  function onNodeClick(node) {
    return event => {
      switch (mode) {
        case ModeType.SELECT_MODE:
          if (!node.selected) {
            gn.selectNode(node)
          } else {
            gn.deselectNode(node)
          }
          break

        case ModeType.NODE_MODE:
          if (event.altKey) {
            gn.removeNode(node)
          }
          break

        case ModeType.LINE_MODE:
          const nodes = gn.getSelectedNodes()

          if (nodes.length === 0) {
            gn.selectNode(node)
          } else {
            const lastSelectedNode = nodes[nodes.length - 1]
            if (lastSelectedNode === node) {
              gn.clearNodeSelections()
            } else {
              gn.createEdge(lastSelectedNode, node)
              gn.clearNodeSelections()
            }
          }
      }
    }
  }

  function onNodeMouseDown(node) {
    return event => {
      onNodeDragStart(node)(event)
    }
  }

  function onNodeDragStart(node) {
    return event => {
      if (mode === ModeType.MOVE_MODE) {
        event.stopPropagation()
        isNodeDragging = true
        draggingNode = node

        isModeLocked = true
      }
    }
  }

  function onNodeDrag(event) {
    gn.restartSimulation(0.6)

    const mouseCoordinates = getMouseCoordinates(event)

    draggingNode.fx = mouseCoordinates.x
    draggingNode.fy = mouseCoordinates.y
  }

  function onEdgeClick(edge) {
    return event => {
      switch (mode) {
        case ModeType.LINE_MODE:
          if (event.altKey) {
            gn.removeEdge(edge)
          }
          break
      }
    }
  }

  function onWindowKeyDown(event) {
    setMode(event)
  }

  function onWindowMouseUp(event) {
    if (mode === ModeType.MOVE_MODE) {
      if (isSvgDragging) {
        onSvgDragEnd(event)
      }

      if (isNodeDragging) {
        onNodeDragEnd(event)
      }
    }
  }

  function onSvgDragStart(event) {
    isSvgDragging = true
    isModeLocked = true
  }

  function onSvgDrag(event) {
    offsetX = offsetX + event.movementX
    offsetY = offsetY + event.movementY
  }

  function onSvgDragEnd(event) {
    isSvgDragging = false
    isModeLocked = false
  }

  function onNodeDragEnd(event) {
    draggingNode.fx = null
    draggingNode.fy = null
    draggingNode = null

    isNodeDragging = false
    isModeLocked = false
  }
</script>
